<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="GN ICON.png" type="image/png">
    <title>FINANCE TRACKER</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary-blue: #34b0e5; --text-dark: #334155; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f5f3ff 100%); color: var(--text-dark); min-height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .glass-sidebar { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border-right: 1px solid rgba(255, 255, 255, 0.6); }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .nav-link { cursor: pointer; transition: all 0.2s ease; }
        .nav-link:hover { background: rgba(255,255,255,0.6); }
        .nav-link.active { background: rgba(52, 176, 229, 0.15); color: var(--primary-blue); border-right: 3px solid var(--primary-blue); font-weight: 600; }
        .kpi-card { border-top: 4px solid var(--primary-blue); }
        td[contenteditable="true"], th[contenteditable="true"], select.editable-input, input.editable-input { background-color: transparent; outline: none; border: 1px dashed transparent; width: 100%; border-radius: 6px; font-size: 0.75rem !important; font-weight: 500; padding: 6px 8px; transition: all 0.2s; }
        td[contenteditable="true"]:hover, select.editable-input:hover, input.editable-input:hover { background-color: rgba(255,255,255,0.8); border: 1px dashed #cbd5e1; }
        td[contenteditable="true"]:focus, select.editable-input:focus, input.editable-input:focus { background-color: white; border: 1px solid var(--primary-blue); box-shadow: 0 0 0 2px rgba(52, 176, 229, 0.1); }
        .hidden { display: none !important; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.5); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #34b0e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .save-indicator { position: fixed; bottom: 20px; right: 20px; background: #10b981; color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; display: none; z-index: 50; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .save-indicator.show { display: flex; }
        .save-indicator.error { background: #ef4444; }
        /* Mobile Sidebar */
        @media (max-width: 1023px) { #sidebar { position: fixed; left: 0; top: 0; z-index: 40; height: 100%; transform: translateX(-100%); transition: transform 0.25s ease-out; } #sidebar.sidebar-open { transform: translateX(0); } #sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 30; } #sidebar-overlay.sidebar-open { display: block; } }
    </style>
</head>
<body class="flex h-screen overflow-hidden min-h-0">
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="closeSidebar()"></div>
    <div id="loading-overlay" class="loading-overlay"><div class="loading-spinner"></div></div>
    <div id="save-indicator" class="save-indicator"><span>Saved</span></div>

    <aside id="sidebar" class="w-64 glass-sidebar flex-shrink-0 flex flex-col h-full overflow-y-auto lg:translate-x-0">
        <div class="p-4 flex items-center gap-3">
            <img src="GN ICON.png" alt="Logo" class="w-10 h-10 rounded-lg shadow-sm">
            <div class="flex flex-col"><span class="text-[10px] font-bold text-slate-500">GN TRAVEL MARKETING</span><span class="text-[15px] font-extrabold text-[#34b0e5]">FINANCE TRACKER</span></div>
            <button class="lg:hidden ml-auto" onclick="closeSidebar()">✕</button>
        </div>
        <nav class="flex-1 px-4 space-y-2 mt-4">
            <div onclick="switchView('dashboard')" id="nav-dashboard" class="nav-link active flex items-center px-4 py-3 text-sm font-medium rounded-xl">Dashboard</div>
            <div onclick="switchView('income')" id="nav-income" class="nav-link text-slate-600 flex items-center px-4 py-3 text-sm font-medium rounded-xl">Income</div>
            <div onclick="switchView('expenses')" id="nav-expenses" class="nav-link text-slate-600 flex items-center px-4 py-3 text-sm font-medium rounded-xl">Expenses</div>
            <div onclick="switchView('cash')" id="nav-cash" class="nav-link text-slate-600 flex items-center px-4 py-3 text-sm font-medium rounded-xl">Cash</div>
        </nav>
        <div class="p-4 border-t border-slate-200/60 text-center"><span class="text-xs text-green-500">● Real-time Active</span></div>
    </aside>

    <main class="flex-1 overflow-y-auto p-4 sm:p-6 relative" id="main-content">
        <button class="lg:hidden fixed top-4 left-4 z-20 w-10 h-10 glass rounded-lg" onclick="toggleSidebar()">☰</button>
        
        <header class="flex flex-wrap justify-between items-center gap-4 mb-6 pt-12 lg:pt-0">
            <div><h1 class="text-2xl font-extrabold text-[#34b0e5]" id="page-title">Dashboard</h1></div>
            <div class="flex gap-2">
                <div class="glass rounded-lg px-2 py-1 flex"><button onclick="toggleCurrency('PHP')" id="btn-php" class="px-2 font-bold text-xs bg-blue-100 text-blue-600 rounded">PHP</button><button onclick="toggleCurrency('USD')" id="btn-usd" class="px-2 font-bold text-xs text-gray-500 rounded">USD</button></div>
                <input type="number" id="year-selector" class="w-16 glass rounded-lg px-2 font-bold text-slate-700 bg-transparent" value="2026" onchange="changeYear(this.value)">
            </div>
        </header>

        <section id="view-dashboard" class="pb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass p-6 rounded-2xl kpi-card"><h3 class="text-xs font-bold text-slate-500 uppercase">Total Revenue</h3><div class="text-2xl font-extrabold text-slate-800" id="kpi-revenue">₱0.00</div></div>
                <div class="glass p-6 rounded-2xl kpi-card"><h3 class="text-xs font-bold text-slate-500 uppercase">Total Expenses</h3><div class="text-2xl font-extrabold text-red-500" id="kpi-expenses">₱0.00</div></div>
                <div class="glass p-6 rounded-2xl kpi-card"><h3 class="text-xs font-bold text-slate-500 uppercase">Net Income</h3><div class="text-2xl font-extrabold text-green-500" id="kpi-net-income">₱0.00</div></div>
                <div class="glass p-6 rounded-2xl kpi-card"><h3 class="text-xs font-bold text-slate-500 uppercase">Margin</h3><div class="text-2xl font-extrabold text-slate-800" id="kpi-margin">0%</div></div>
            </div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <div class="glass rounded-2xl p-4 overflow-x-auto">
                    <h3 class="font-bold text-[#34b0e5] mb-4">Summary</h3>
                    <table class="w-full text-sm text-left" id="table-main"><thead class="text-xs text-slate-500 uppercase bg-white/50"><tr><th class="px-4 py-2">Month</th><th class="px-4 py-2 text-right">Income</th><th class="px-4 py-2 text-right">Expense</th><th class="px-4 py-2 text-right">Net</th></tr></thead><tbody class="divide-y divide-slate-200"></tbody></table>
                </div>
            </div>
        </section>

        <section id="view-income" class="hidden pb-8">
            <div class="glass rounded-2xl shadow-sm mb-8 overflow-hidden">
                <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                    <h3 class="font-bold text-[#34b0e5]">Income Records</h3>
                    <button onclick="addIncomeRow()" class="bg-[#34b0e5] text-white px-3 py-1.5 rounded-md text-sm font-bold shadow hover:bg-sky-500">+ Add Entry</button>
                </div>
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-sm text-left min-w-[800px]">
                        <thead class="text-xs text-slate-700 uppercase bg-white/40 sticky top-0 backdrop-blur-md">
                            <tr>
                                <th class="px-4 py-3">Date</th><th class="px-4 py-3">Client</th><th class="px-4 py-3">Service</th><th class="px-4 py-3">Model</th>
                                <th class="px-4 py-3 text-right">Gross</th><th class="px-4 py-3 text-right">Net</th><th class="px-4 py-3">Status</th><th class="px-4 py-3">Notes</th><th class="px-2 py-3"></th>
                            </tr>
                        </thead>
                        <tbody id="tracker-body" class="divide-y divide-slate-200/60 font-medium"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="view-expenses" class="hidden pb-8">
            <div class="glass rounded-2xl shadow-sm mb-8 overflow-hidden">
                <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                    <h3 class="font-bold text-[#34b0e5]">Expense Records</h3>
                    <button onclick="addExpenseRow()" class="bg-[#34b0e5] text-white px-3 py-1.5 rounded-md text-sm font-bold shadow hover:bg-sky-500">+ Add Expense</button>
                </div>
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-sm text-left min-w-[800px]">
                        <thead class="text-xs text-slate-700 uppercase bg-white/40 sticky top-0 backdrop-blur-md">
                            <tr>
                                <th class="px-4 py-3">Date</th><th class="px-4 py-3">Vendor</th><th class="px-4 py-3">Category</th>
                                <th class="px-4 py-3 text-right">Amount</th><th class="px-4 py-3">Status</th><th class="px-4 py-3">Notes</th><th class="px-2 py-3"></th>
                            </tr>
                        </thead>
                        <tbody id="expenses-body" class="divide-y divide-slate-200/60 font-medium"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="view-cash" class="hidden pb-8">
             <div class="glass rounded-2xl shadow-sm mb-8 overflow-hidden">
                <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                    <h3 class="font-bold text-[#34b0e5]">Cash Accounts</h3>
                    <button onclick="addCashAccountRow()" class="bg-[#34b0e5] text-white px-3 py-1.5 rounded-md text-sm font-bold shadow hover:bg-sky-500">+ Add Account</button>
                </div>
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-sm text-left min-w-[600px]">
                        <thead class="text-xs text-slate-700 uppercase bg-white/40">
                            <tr><th class="px-4 py-3">Month</th><th class="px-4 py-3">Account</th><th class="px-4 py-3">Category</th><th class="px-4 py-3 text-right">Balance</th><th class="px-2 py-3"></th></tr>
                        </thead>
                        <tbody id="cash-balances-body" class="divide-y divide-slate-200/60 font-medium"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

    <script>
        // --- CONFIG ---
        // !!! REPLACE THESE WITH YOUR ACTUAL SUPABASE KEYS !!!
        const SUPABASE_URL = 'https://udlnhhngwcqdjdwcheyd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkbG5oaG5nd2NxZGpkd2NoZXlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5ODM1NzMsImV4cCI6MjA4NTU1OTU3M30.3WeLLTCqvl3IT4YhfS77bA8cx7R2fVfyEXZ3mJaYG5w';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const API_BASE = '/api';
        const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        // --- STATE ---
        let currentYear = new Date().getFullYear();
        let currentCurrency = 'PHP';
        let exchangeRate = 58;
        let incomeRecords = [], expenseRecords = [], cashAccounts = [], dashboardExpenses = {};
        let saveTimeout = null;

        // --- INIT ---
        window.onload = async () => {
            console.log("App Starting...");
            setupRealtime();
            await loadData();
        };

        // --- REALTIME SETUP ---
        function setupRealtime() {
            const channel = supabaseClient.channel('finance-db-changes')
            
            // INCOME LISTENER
            .on('postgres_changes', { event: '*', schema: 'public', table: 'income_records' }, payload => {
                console.log('Realtime Income Event:', payload);
                if (payload.eventType === 'INSERT') {
                    const newRec = toIncomeFE(payload.new);
                    incomeRecords.push(newRec);
                    // Append only, don't re-render all to preserve focus
                    const tr = createIncomeRow(newRec);
                    document.getElementById('tracker-body').appendChild(tr);
                } 
                else if (payload.eventType === 'UPDATE') {
                    const idx = incomeRecords.findIndex(r => r.id === payload.new.id);
                    if (idx !== -1) {
                        incomeRecords[idx] = toIncomeFE(payload.new);
                        // Smart Update: Check if row exists and isn't being edited
                        const row = document.querySelector(`tr[data-id="${payload.new.id}"]`);
                        if (row && !row.contains(document.activeElement)) {
                            const newRow = createIncomeRow(incomeRecords[idx]);
                            row.replaceWith(newRow);
                        }
                    }
                } 
                else if (payload.eventType === 'DELETE') {
                    incomeRecords = incomeRecords.filter(r => r.id !== payload.old.id);
                    const row = document.querySelector(`tr[data-id="${payload.old.id}"]`);
                    if(row) row.remove();
                }
                calculateDashboard(); // Update stats
            })

            // EXPENSE LISTENER
            .on('postgres_changes', { event: '*', schema: 'public', table: 'expense_records' }, payload => {
                console.log('Realtime Expense Event:', payload);
                if (payload.eventType === 'INSERT') {
                    const newRec = toExpenseFE(payload.new);
                    expenseRecords.push(newRec);
                    document.getElementById('expenses-body').appendChild(createExpenseRow(newRec));
                } else if (payload.eventType === 'UPDATE') {
                    const idx = expenseRecords.findIndex(r => r.id === payload.new.id);
                    if (idx !== -1) {
                        expenseRecords[idx] = toExpenseFE(payload.new);
                        const row = document.querySelector(`tr[data-id="${payload.new.id}"]`);
                        if (row && !row.contains(document.activeElement)) {
                            row.replaceWith(createExpenseRow(expenseRecords[idx]));
                        }
                    }
                } else if (payload.eventType === 'DELETE') {
                    expenseRecords = expenseRecords.filter(r => r.id !== payload.old.id);
                    const row = document.querySelector(`tr[data-id="${payload.old.id}"]`);
                    if(row) row.remove();
                }
                calculateDashboard();
            })
            
            // CASH LISTENER
            .on('postgres_changes', { event: '*', schema: 'public', table: 'cash_accounts' }, payload => {
                 // ... similar logic can be added here ...
                 loadData(); // Lazier reload for cash is usually fine as it's less frequent
            })

            .subscribe((status) => {
                console.log("Realtime Status:", status);
            });
        }

        // --- DATA LOADERS ---
        async function loadData() {
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                // Fetching via your Next.js API (which talks to Supabase)
                const [inc, exp, cash, biz] = await Promise.all([
                    apiGet('income'),
                    apiGet('expenses'),
                    apiGet('cash?type=accounts'),
                    apiGet('business')
                ]);

                if(inc) incomeRecords = inc;
                if(exp) expenseRecords = exp;
                if(cash) cashAccounts = cash;
                if(biz && biz.dashboardExpenses) dashboardExpenses = biz.dashboardExpenses;

                renderIncomeTable();
                renderExpenseTable();
                renderCashTable();
                calculateDashboard();
            } catch (e) { console.error(e); }
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // --- RENDERERS (Initial Load) ---
        function renderIncomeTable() {
            const tbody = document.getElementById('tracker-body');
            tbody.innerHTML = '';
            // Filter by year
            const filtered = incomeRecords.filter(r => !r.date || r.date.startsWith(currentYear));
            filtered.forEach(r => tbody.appendChild(createIncomeRow(r)));
        }

        function createIncomeRow(r) {
            const tr = document.createElement('tr');
            tr.setAttribute('data-id', r.id);
            tr.className = "hover:bg-blue-50/50 transition-colors group";
            tr.innerHTML = `
                <td class="px-4 py-2 border-r border-slate-200"><input type="date" value="${r.date||''}" class="editable-input" onchange="updateIncome(this)"></td>
                <td class="px-4 py-2 border-r border-slate-200" contenteditable="true" onblur="updateIncome(this)">${r.clientName||''}</td>
                <td class="px-4 py-2 border-r border-slate-200">${makeSelect(['Social Media','VA','Ads','Design'], r.serviceType, 'updateIncome(this)')}</td>
                <td class="px-4 py-2 border-r border-slate-200">${makeSelect(['Retainer','Project'], r.pricingModel, 'updateIncome(this)')}</td>
                <td class="px-4 py-2 border-r border-slate-200 text-right" contenteditable="true" onblur="updateIncome(this)">${formatMoney(r.gross)}</td>
                <td class="px-4 py-2 border-r border-slate-200 text-right" contenteditable="true" onblur="updateIncome(this)">${formatMoney(r.net)}</td>
                <td class="px-4 py-2 border-r border-slate-200">${makeSelect(['Paid','Pending'], r.status, 'updateIncome(this)')}</td>
                <td class="px-4 py-2 border-r border-slate-200" contenteditable="true" onblur="updateIncome(this)">${r.notes||''}</td>
                <td class="px-2 py-2 text-center"><button onclick="deleteIncome(this)" class="text-gray-300 group-hover:text-red-400">✕</button></td>
            `;
            return tr;
        }

        function renderExpenseTable() {
            const tbody = document.getElementById('expenses-body');
            tbody.innerHTML = '';
            const filtered = expenseRecords.filter(r => !r.date || r.date.startsWith(currentYear));
            filtered.forEach(r => tbody.appendChild(createExpenseRow(r)));
        }

        function createExpenseRow(r) {
            const tr = document.createElement('tr');
            tr.setAttribute('data-id', r.id);
            tr.className = "hover:bg-red-50/50 transition-colors group";
            tr.innerHTML = `
                <td class="px-4 py-2 border-r border-slate-200"><input type="date" value="${r.date||''}" class="editable-input" onchange="updateExpense(this)"></td>
                <td class="px-4 py-2 border-r border-slate-200" contenteditable="true" onblur="updateExpense(this)">${r.vendor||''}</td>
                <td class="px-4 py-2 border-r border-slate-200">${makeSelect(['Software','Payroll','Tax','Ads'], r.category, 'updateExpense(this)')}</td>
                <td class="px-4 py-2 border-r border-slate-200 text-right" contenteditable="true" onblur="updateExpense(this)">${formatMoney(r.amount)}</td>
                <td class="px-4 py-2 border-r border-slate-200">${makeSelect(['Paid','Pending'], r.status, 'updateExpense(this)')}</td>
                <td class="px-4 py-2 border-r border-slate-200" contenteditable="true" onblur="updateExpense(this)">${r.notes||''}</td>
                <td class="px-2 py-2 text-center"><button onclick="deleteExpense(this)" class="text-gray-300 group-hover:text-red-400">✕</button></td>
            `;
            return tr;
        }

        function renderCashTable() {
            const tbody = document.getElementById('cash-balances-body');
            tbody.innerHTML = '';
            cashAccounts.forEach(r => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-id', r.id);
                tr.innerHTML = `
                    <td class="px-4 py-2 border-r border-slate-200">${makeSelect(MONTHS, r.month, 'updateCash(this)')}</td>
                    <td class="px-4 py-2 border-r border-slate-200" contenteditable="true" onblur="updateCash(this)">${r.accountName}</td>
                    <td class="px-4 py-2 border-r border-slate-200" contenteditable="true" onblur="updateCash(this)">${r.category}</td>
                    <td class="px-4 py-2 border-r border-slate-200 text-right" contenteditable="true" onblur="updateCash(this)">${formatMoney(r.balance)}</td>
                    <td class="px-2 py-2 text-center"><button onclick="deleteCash(this)" class="text-gray-300 hover:text-red-400">✕</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- ACTIONS ---
        function addIncomeRow() {
            const newRec = { id: Date.now().toString(), date: new Date().toISOString().split('T')[0], clientName: 'New Client', serviceType: 'VA', pricingModel: 'Retainer', gross: 0, net: 0, status: 'Pending' };
            incomeRecords.push(newRec);
            const tr = createIncomeRow(newRec);
            document.getElementById('tracker-body').appendChild(tr);
            apiPut('income', newRec); // Save to DB -> Triggers Realtime -> Updates others
        }
        
        function updateIncome(el) {
            const tr = el.closest('tr');
            const id = tr.getAttribute('data-id');
            const idx = incomeRecords.findIndex(r => r.id === id);
            if (idx === -1) return;
            
            const cells = tr.querySelectorAll('td');
            const updated = {
                ...incomeRecords[idx],
                date: cells[0].querySelector('input').value,
                clientName: cells[1].innerText,
                serviceType: cells[2].querySelector('select').value,
                pricingModel: cells[3].querySelector('select').value,
                gross: parseMoney(cells[4].innerText),
                net: parseMoney(cells[5].innerText),
                status: cells[6].querySelector('select').value,
                notes: cells[7].innerText
            };
            incomeRecords[idx] = updated;
            cells[4].innerText = formatMoney(updated.gross);
            cells[5].innerText = formatMoney(updated.net);
            
            calculateDashboard();
            scheduleSave(() => apiPut('income', updated));
        }

        function deleteIncome(btn) {
            const id = btn.closest('tr').getAttribute('data-id');
            btn.closest('tr').remove();
            incomeRecords = incomeRecords.filter(r => r.id !== id);
            apiDelete('income', id);
            calculateDashboard();
        }

        // Expense Actions
        function addExpenseRow() {
            const newRec = { id: Date.now().toString(), date: new Date().toISOString().split('T')[0], vendor: 'New Vendor', category: 'Software', amount: 0, status: 'Paid' };
            expenseRecords.push(newRec);
            document.getElementById('expenses-body').appendChild(createExpenseRow(newRec));
            apiPut('expenses', newRec);
        }
        function updateExpense(el) {
            const tr = el.closest('tr');
            const id = tr.getAttribute('data-id');
            const idx = expenseRecords.findIndex(r => r.id === id);
            if(idx === -1) return;
            const cells = tr.querySelectorAll('td');
            const updated = {
                ...expenseRecords[idx],
                date: cells[0].querySelector('input').value,
                vendor: cells[1].innerText,
                category: cells[2].querySelector('select').value,
                amount: parseMoney(cells[3].innerText),
                status: cells[4].querySelector('select').value,
                notes: cells[5].innerText
            };
            expenseRecords[idx] = updated;
            cells[3].innerText = formatMoney(updated.amount);
            calculateDashboard();
            scheduleSave(() => apiPut('expenses', updated));
        }
        function deleteExpense(btn) {
            const id = btn.closest('tr').getAttribute('data-id');
            btn.closest('tr').remove();
            expenseRecords = expenseRecords.filter(r => r.id !== id);
            apiDelete('expenses', id);
        }

        // Cash Actions
        function addCashAccountRow() {
            const newRec = { id: Date.now().toString(), month: MONTHS[0], accountName: 'Bank', category: 'Ops', balance: 0 };
            cashAccounts.push(newRec);
            renderCashTable();
            apiPut('cash?type=accounts', newRec);
        }
        function updateCash(el) {
             const tr = el.closest('tr');
             const id = tr.getAttribute('data-id');
             const idx = cashAccounts.findIndex(r => r.id === id);
             if(idx === -1) return;
             const cells = tr.querySelectorAll('td');
             const updated = {
                 ...cashAccounts[idx],
                 month: cells[0].querySelector('select').value,
                 accountName: cells[1].innerText,
                 category: cells[2].innerText,
                 balance: parseMoney(cells[3].innerText)
             };
             cashAccounts[idx] = updated;
             scheduleSave(() => apiPut('cash?type=accounts', updated));
        }
        function deleteCash(btn) {
            const id = btn.closest('tr').getAttribute('data-id');
            btn.closest('tr').remove();
            cashAccounts = cashAccounts.filter(r => r.id !== id);
            apiDelete('cash?type=accounts', id);
        }


        // --- DASHBOARD CALCULATIONS ---
        function calculateDashboard() {
            const totalInc = incomeRecords.filter(r => r.date.startsWith(currentYear)).reduce((sum, r) => sum + (r.net || 0), 0);
            const totalExp = expenseRecords.filter(r => r.date.startsWith(currentYear)).reduce((sum, r) => sum + (r.amount || 0), 0);
            const net = totalInc - totalExp;
            const margin = totalInc > 0 ? (net/totalInc)*100 : 0;

            document.getElementById('kpi-revenue').innerText = formatMoney(totalInc);
            document.getElementById('kpi-expenses').innerText = formatMoney(totalExp);
            document.getElementById('kpi-net-income').innerText = formatMoney(net);
            document.getElementById('kpi-margin').innerText = margin.toFixed(1) + '%';
            
            // Render Monthly Summary Table
            const tbody = document.querySelector('#table-main tbody');
            tbody.innerHTML = '';
            MONTHS.forEach((m, i) => {
                const monthNum = String(i + 1).padStart(2, '0');
                const mInc = incomeRecords.filter(r => r.date.startsWith(`${currentYear}-${monthNum}`)).reduce((s, r) => s + r.net, 0);
                const mExp = expenseRecords.filter(r => r.date.startsWith(`${currentYear}-${monthNum}`)).reduce((s, r) => s + r.amount, 0);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-4 py-2 font-bold">${m}</td><td class="px-4 py-2 text-right">${formatMoney(mInc)}</td><td class="px-4 py-2 text-right text-red-400">${formatMoney(mExp)}</td><td class="px-4 py-2 text-right font-bold ${mInc-mExp>=0?'text-green-500':'text-red-500'}">${formatMoney(mInc-mExp)}</td>`;
                tbody.appendChild(tr);
            });
        }

        // --- UTILS ---
        function makeSelect(options, selected, onchange) {
            return `<select class="editable-input" onchange="${onchange}">${options.map(o => `<option value="${o}" ${o===selected?'selected':''}>${o}</option>`).join('')}</select>`;
        }
        function parseMoney(val) { return Number((val||'0').toString().replace(/[^0-9.-]+/g,"")) || 0; }
        function formatMoney(val) { return (currentCurrency==='USD' ? '$' : '₱') + (val||0).toLocaleString(undefined, {minimumFractionDigits:2}); }
        function toggleCurrency(c) { currentCurrency = c; renderIncomeTable(); renderExpenseTable(); calculateDashboard(); }
        function changeYear(y) { currentYear = y; renderIncomeTable(); renderExpenseTable(); calculateDashboard(); }
        function showSave() { const el = document.getElementById('save-indicator'); el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 1500); }
        function scheduleSave(fn) { if(saveTimeout) clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { fn(); showSave(); }, 1000); }
        
        // Mappers (DB snake_case -> FE camelCase)
        const toIncomeFE = (row) => ({ id: row.id, date: row.date, clientName: row.client_name, serviceType: row.service_type, pricingModel: row.pricing_model, gross: row.gross, net: row.net, status: row.status, notes: row.notes });
        const toExpenseFE = (row) => ({ id: row.id, date: row.date, vendor: row.vendor, category: row.category, amount: row.amount, status: row.status, notes: row.notes });

        // API Wrappers
        async function apiGet(ep) { const res = await fetch(`${API_BASE}/${ep}`); const j = await res.json(); return j.success ? j.data : null; }
        async function apiPut(ep, data) { await fetch(`${API_BASE}/${ep}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) }); }
        async function apiDelete(ep, id) { await fetch(`${API_BASE}/${ep}?id=${id}`, { method: 'DELETE' }); }
        
        // Mobile UI
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('translate-x-0'); document.getElementById('sidebar-overlay').classList.toggle('hidden'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('translate-x-0'); document.getElementById('sidebar-overlay').classList.add('hidden'); }
        function switchView(id) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active', 'bg-blue-50', 'text-blue-600'));
            document.getElementById(`nav-${id}`).classList.add('active');
            closeSidebar();
        }
    </script>
</body>
</html>
